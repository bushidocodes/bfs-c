#include <stdlib.h>
#include <stdio.h>
#include <stdbool.h>
#include <time.h>
#include <mpi.h>
#include "aml.h"
#include "aml.c"
#include "constants.h"
#include "globals.c"
#include "bfs.c"

int main(int argc, char *argv[])
{
    /* Problem Vars */
    unsigned long start;
    // Initialize queue
    // queue *current_queue, *temp;
    // current_queue = malloc(sizeof(queue));
    unsigned long vertex;
    // reset(current_queue, false);

    /* MPI Setup */
    aml_init(&argc, &argv); //includes MPI_Init inside
    createGlobals();
    aml_barrier();
    read_graph();

    // Generate a Random Start Vertex and begin BFS
    srand(time(0));
    printf("# Vertices: %lu\n", g->number_vertices);
    start = rand() % (g->number_vertices - 1);
    printf("%d generated random start of %lu\n", processId, start);
    edgerecord *record = malloc(sizeof(edgerecord));
    record->destination = start;
    record->source = start;
    if (processId == 0)
    {
        aml_send(record, 4, sizeof(edgerecord), record->destination % noProcesses); /* processneighborHandler */
    } 

    aml_barrier();
    // if (processId == 0)
    // {
    //     for (int i = 0; i < noProcesses; i++)
    //     {
    //         aml_send(dummy, 5, 0, i);
    //     }
    // }
    sleep(1);
    aml_barrier();
    while (len(current_queue) > 0)
    {
        vertex = dequeue(current_queue);
        printf("%d dequeued %lu\n", processId, vertex);
        // send AML
        edgerecord *record = malloc(sizeof(edgerecord));
        record->source = vertex;
        aml_send(record, 3, sizeof(edgerecord), vertex % noProcesses); /* findNeighborsHandler */
    }
    // aml_barrier();
    // if (processId == 0)
    // {
    //     for (int i = 0; i < noProcesses; i++)
    //     {
    //         aml_send(dummy, 5, 0, i);
    //     }
    // }
    // sleep(1);
    // aml_barrier();
    // while (len(current_queue) > 0)
    // {
    //     vertex = dequeue(current_queue);
    //     printf("%d dequeued %lu\n", processId, vertex);
    //     // send AML
    //     edgerecord *record = malloc(sizeof(edgerecord));
    //     record->source = vertex;
    //     aml_send(record, 3, sizeof(edgerecord), vertex % noProcesses); /* findNeighborsHandler */
    // }

    // Print the Parents List generated by the BFS to STDOUT
    // print_parents(g);
    // }
    // else
    // {
    //     /* This is a big hack to keep the processes other than 0 from hitting the barrier before 0 sends the start BFS message */
    //     sleep(1);
    // }
    aml_barrier();
    aml_finalize(); //includes MPI_Finalize()
    cleanGlobals();
    return 0;
}